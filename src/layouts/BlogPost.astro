---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import TagPill from '../components/TagPill.astro';
import TableOfContents from '../components/TableOfContents.astro';

type Props = CollectionEntry<'blog'>['data'] & {
  headings?: { depth: number; slug: string; text: string }[];
};

const { title, description, pubDate, updatedDate, heroImage, tags = [], headings = [] } = Astro.props;

// Calculate reading time (rough estimate: 200 words per minute)
const content = await Astro.slots.render('default');
const wordCount = content.split(/\s+/).length;
const readingTime = Math.ceil(wordCount / 200);
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={title} description={description} />
  </head>
  <body>
    <Header />
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <main>
      <div class="post-container">
        <article class="prose">
          {heroImage && (
            <div class="hero-image">
              <img src={heroImage} alt={title} />
            </div>
          )}
          <header class="post-header">
            <h1>{title}</h1>
            <div class="post-meta">
              <FormattedDate date={pubDate} />
              <span class="separator">&middot;</span>
              <span>{readingTime} min read</span>
              {updatedDate && (
                <>
                  <span class="separator">&middot;</span>
                  <span class="updated">Updated <FormattedDate date={updatedDate} /></span>
                </>
              )}
            </div>
            {tags.length > 0 && (
              <div class="post-tags">
                {tags.map((tag) => (
                  <TagPill tag={tag} />
                ))}
              </div>
            )}
          </header>
          <div class="post-content">
            <slot />
          </div>
          <footer class="post-footer">
            <a href="/blog" class="back-link">&larr; Back to blog</a>
          </footer>
        </article>
        <TableOfContents headings={headings} />
      </div>
    </main>
    <Footer />
    <script>
      function initProgressBar() {
        const progressBar = document.getElementById('progressBar');
        if (!progressBar) return;

        function updateProgress() {
          const scrollTop = window.scrollY || document.documentElement.scrollTop;
          const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
          const progress = (scrollTop / scrollHeight) * 100;
          progressBar.style.width = `${Math.min(100, Math.max(0, progress))}%`;
        }

        window.addEventListener('scroll', updateProgress, { passive: true });
        updateProgress();
      }

      function initTocObserver() {
        const tocLinks = document.querySelectorAll('.toc-link');
        const headings = document.querySelectorAll('.post-content :is(h2, h3)');

        if (tocLinks.length === 0 || headings.length === 0) return;

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                const id = entry.target.getAttribute('id');
                tocLinks.forEach((link) => {
                  link.classList.toggle('toc-active', link.getAttribute('href') === `#${id}`);
                });
              }
            });
          },
          { rootMargin: '-100px 0px -66%' }
        );

        headings.forEach((h) => observer.observe(h));
      }

      initProgressBar();
      document.addEventListener('astro:page-load', initProgressBar);

      initTocObserver();
      document.addEventListener('astro:page-load', initTocObserver);
    </script>
  </body>
</html>

<style>
  .progress-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: transparent;
    z-index: 9999;
  }

  .progress-bar {
    height: 100%;
    background: var(--accent);
    width: 0%;
    transition: width 0.1s ease-out;
  }

  .post-container {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-xl);
  }

  .prose {
    flex: 1;
    max-width: var(--content-width);
    min-width: 0;
  }

  @media (max-width: 1023px) {
    .post-container {
      display: block;
    }
  }

  .hero-image {
    margin-bottom: var(--spacing-xl);
    border-radius: 8px;
    overflow: hidden;
  }

  .hero-image img {
    width: 100%;
    height: auto;
    display: block;
    object-fit: cover;
  }

  .post-header {
    margin-bottom: var(--spacing-xl);
  }

  .post-header h1 {
    margin-bottom: var(--spacing-sm);
    line-height: 1.2;
  }

  .post-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-bottom: var(--spacing-sm);
  }

  .separator {
    color: var(--border);
  }

  .updated {
    font-style: italic;
  }

  .post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-xs);
  }

  .post-content {
    margin-bottom: var(--spacing-xl);
  }

  .post-content :global(p) {
    text-align: justify;
  }

  .post-content :global(h2) {
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-sm);
  }

  .post-content :global(h3) {
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-sm);
  }

  .post-content :global(pre) {
    margin: var(--spacing-lg) 0;
  }

  .post-content :global(img) {
    margin: var(--spacing-lg) 0;
  }

  .post-footer {
    padding-top: var(--spacing-lg);
    border-top: 1px solid var(--border);
  }

  .back-link {
    font-size: 0.9rem;
  }
</style>
